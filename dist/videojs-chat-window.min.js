!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("video.js")):"function"==typeof define&&define.amd?define(["video.js"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).videojsChatWindow=e(t.videojs)}(this,function(t){"use strict";const e=t?.default||t;class s{constructor(t,s={}){this.player=t,this.options_=s,this.isVisible=!1,this._polling=!1,this._lastId=null,this._pollController=null,t.ready(()=>{t.controlBar&&t.controlBar.pictureInPictureToggle&&t.controlBar.pictureInPictureToggle.hide(),this.container||(this.container=e.dom.createEl("div",{className:"vjs-chat-window"}),this.messages=e.dom.createEl("div",{className:"vjs-chat-messages"}),this.messages.setAttribute("role","log"),this.messages.setAttribute("aria-live","polite"),this.input=e.dom.createEl("input",{className:"vjs-chat-input",type:"text",placeholder:s.placeholder||"Type a messageâ€¦"}),this.input.setAttribute("aria-label","Chat input"),this.container.appendChild(this.messages),this.container.appendChild(this.input),t.controlBar.el().appendChild(this.container),this._onKeyDown=t=>{if("Enter"===t.key&&this.input.value.trim()){const t=this.input.value.trim();this.addMessage(s.username||"You",t),this.input.value="",this._sendToServer(t)}},this.input.addEventListener("keydown",this._onKeyDown)),this._addToggleButton(t),this.options_.endpoint&&this._startPolling(),t.on("dispose",()=>this.dispose())})}_addToggleButton(t){const s=e.getComponent("Button"),i=this;const n=t.controlBar;if(!n)return;const o=new class extends s{constructor(t,e){super(t,e),this.controlText("Chat"),this.addClass("vjs-chat-toggle");const s=this.el().querySelector(".vjs-icon-placeholder");s&&(s.innerHTML='\n            <svg viewBox="0 0 24 24" width="18" height="18"\n                 stroke="currentColor" fill="none" stroke-width="2"\n                 stroke-linecap="round" stroke-linejoin="round"\n                 style="pointer-events:none">\n              <path d="M12 22l3-3h3a3 3 0 0 0 3-3V5a3 3 0 0 0-3-3H6A3 3 0 0 0 3 5v11a3 3 0 0 0 3 3h3l3 3z"/>\n              <path d="M8 9h8"/><path d="M8 13h5"/>\n            </svg>\n          ')}handleClick(){i.toggleChat()}}(t),a=n.getChild("FullscreenToggle")||n.getChild("fullscreenToggle");a?n.addChild(o,{},n.children().indexOf(a)):n.addChild(o)}toggleChat(){this.isVisible=!this.isVisible,this.container&&(this.container.style.display=this.isVisible?"flex":"none"),this.isVisible&&(this.messages.scrollTop=this.messages.scrollHeight,this.input&&this.input.focus())}addMessage(t,s){if(!this.messages)return;const i=e.dom.createEl("div",{className:"vjs-chat-message",innerHTML:'<strong class="vjs-chat-user"></strong><span class="vjs-chat-text"></span>'});i.querySelector(".vjs-chat-user").textContent=`${t}: `,i.querySelector(".vjs-chat-text").textContent=s,this.messages.appendChild(i),this.messages.scrollTop=this.messages.scrollHeight}_endpoint(t){return this.options_.endpoint?this.options_.endpoint.replace(/\/+$/,"")+t:null}async _sendToServer(t){const e=this._endpoint("/send");if(e)try{await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",...this.options_.headers||{}},credentials:this.options_.credentials||"same-origin",body:JSON.stringify({message:t,session_id:this.options_.sessionId||null})})}catch(t){}}_startPolling(){if(this._polling)return;this._polling=!0;(async()=>{for(;this._polling;){this._pollController=new AbortController;try{const t=this._endpoint("/poll");if(!t)return;const e=new URL(t,window.location.origin);this._lastId&&e.searchParams.set("since_id",this._lastId),this.options_.sessionId&&e.searchParams.set("session_id",this.options_.sessionId);const s=await fetch(e.toString(),{headers:{...this.options_.headers||{}},credentials:this.options_.credentials||"same-origin",signal:this._pollController.signal});if(!s.ok)throw new Error;const i=await s.json();if(i&&Array.isArray(i.messages))for(const t of i.messages)t.id&&(this._lastId=t.id),"text"===t.type?this.addMessage(t.user||this.options_.botName||"Bot",t.text||""):"command"===t.type&&this._executeCommand(t.command,t.args||{})}catch(t){await new Promise(t=>setTimeout(t,1e3))}}})()}_executeCommand(t,e={}){const s=this.player;switch(t){case"pause":s.pause();break;case"play":s.play();break;case"restart":s.currentTime(0),s.play();break;case"seek":"number"==typeof e.time&&s.currentTime(e.time);break;case"rate":"number"==typeof e.rate&&s.playbackRate(e.rate);break;case"mute":s.muted(!0);break;case"unmute":s.muted(!1);break;case"loadSource":e.src&&e.type&&s.src({src:e.src,type:e.type})}}dispose(){this._polling=!1,this._pollController&&this._pollController.abort(),this.input&&this._onKeyDown&&this.input.removeEventListener("keydown",this._onKeyDown),this.container?.parentNode&&this.container.parentNode.removeChild(this.container)}}const i="function"==typeof e.registerPlugin&&e.registerPlugin||"function"==typeof e.plugin&&e.plugin;return i&&i.call(e,"chatWindow",function(t){return this.chatWindow_||(this.chatWindow_=new s(this,t)),this.chatWindow_}),s});
