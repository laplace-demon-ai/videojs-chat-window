!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("video.js")):"function"==typeof define&&define.amd?define(["video.js"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).videojsChatWindow=t(e.videojs)}(this,function(e){"use strict";class t{constructor(t,s={}){this.player=t,this.options_=s,this.isVisible=!1,this._polling=!1,this._lastId=null,this._pollController=null,t.ready(()=>{t.controlBar&&t.controlBar.pictureInPictureToggle&&t.controlBar.pictureInPictureToggle.hide(),this.container||(this.container=e.dom.createEl("div",{className:"vjs-chat-window"}),this.messages=e.dom.createEl("div",{className:"vjs-chat-messages"}),this.messages.setAttribute("role","log"),this.messages.setAttribute("aria-live","polite"),this.input=e.dom.createEl("input",{className:"vjs-chat-input",type:"text",placeholder:s.placeholder||"Type a messageâ€¦"}),this.input.setAttribute("aria-label","Chat input"),this.container.appendChild(this.messages),this.container.appendChild(this.input),t.controlBar.el().appendChild(this.container),this._onKeyDown=e=>{if("Enter"===e.key&&this.input.value.trim()){const e=this.input.value.trim();this.addMessage(s.username||"You",e),this.input.value="",this._sendToServer(e)}},this.input.addEventListener("keydown",this._onKeyDown)),this._addToggleButton(t),this.options_.endpoint&&this._startPolling(),t.on("dispose",()=>this.dispose())})}_addToggleButton(t){const s=e.getComponent("Button"),i=this;const n=t.controlBar;if(!n)return;const o=new class extends s{constructor(e,t){super(e,t),this.controlText("Chat"),this.addClass("vjs-chat-toggle");const s=this.el().querySelector(".vjs-icon-placeholder");s&&(s.innerHTML='\n            <svg viewBox="0 0 24 24" width="18" height="18"\n                 stroke="currentColor" fill="none" stroke-width="2"\n                 stroke-linecap="round" stroke-linejoin="round"\n                 style="pointer-events:none">\n              <path d="M12 22l3-3h3a3 3 0 0 0 3-3V5a3 3 0 0 0-3-3H6A3 3 0 0 0 3 5v11a3 3 0 0 0 3 3h3l3 3z"/>\n              <path d="M8 9h8"/><path d="M8 13h5"/>\n            </svg>\n          ')}handleClick(){i.toggleChat()}}(t),a=n.getChild("FullscreenToggle")||n.getChild("fullscreenToggle");a?n.addChild(o,{},n.children().indexOf(a)):n.addChild(o)}toggleChat(){this.isVisible=!this.isVisible,this.container&&(this.container.style.display=this.isVisible?"flex":"none"),this.isVisible&&(this.messages.scrollTop=this.messages.scrollHeight,this.input&&this.input.focus())}addMessage(t,s){if(!this.messages)return;const i=e.dom.createEl("div",{className:"vjs-chat-message",innerHTML:'<strong class="vjs-chat-user"></strong><span class="vjs-chat-text"></span>'});i.querySelector(".vjs-chat-user").textContent=`${t}: `,i.querySelector(".vjs-chat-text").textContent=s,this.messages.appendChild(i),this.messages.scrollTop=this.messages.scrollHeight}_endpoint(e){return this.options_.endpoint?this.options_.endpoint.replace(/\/+$/,"")+e:null}async _sendToServer(e){const t=this._endpoint("/send");if(t)try{await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",...this.options_.headers||{}},credentials:this.options_.credentials||"same-origin",body:JSON.stringify({message:e,session_id:this.options_.sessionId||null})})}catch(e){}}_startPolling(){if(this._polling)return;this._polling=!0;(async()=>{for(;this._polling;){this._pollController=new AbortController;try{const e=this._endpoint("/poll");if(!e)return;const t=new URL(e,window.location.origin);this._lastId&&t.searchParams.set("since_id",this._lastId),this.options_.sessionId&&t.searchParams.set("session_id",this.options_.sessionId);const s=await fetch(t.toString(),{headers:{...this.options_.headers||{}},credentials:this.options_.credentials||"same-origin",signal:this._pollController.signal});if(!s.ok)throw new Error("poll failed");const i=await s.json();if(i&&Array.isArray(i.messages))for(const e of i.messages)e.id&&(this._lastId=e.id),"text"===e.type?this.addMessage(e.user||this.options_.botName||"Bot",e.text||""):"command"===e.type&&this._executeCommand(e.command,e.args||{})}catch(e){await new Promise(e=>setTimeout(e,1e3))}}})()}_executeCommand(e,t={}){const s=this.player;switch(e){case"pause":s.pause();break;case"play":s.play();break;case"restart":s.currentTime(0),s.play();break;case"seek":"number"==typeof t.time&&s.currentTime(t.time);break;case"rate":"number"==typeof t.rate&&s.playbackRate(t.rate);break;case"mute":s.muted(!0);break;case"unmute":s.muted(!1);break;case"loadSource":t.src&&t.type&&s.src({src:t.src,type:t.type})}}dispose(){this._polling=!1,this._pollController&&this._pollController.abort(),this.input&&this._onKeyDown&&this.input.removeEventListener("keydown",this._onKeyDown),this.container?.parentNode&&this.container.parentNode.removeChild(this.container)}}return(e.registerPlugin||e.plugin)("chatWindow",function(e){return this.chatWindow_||(this.chatWindow_=new t(this,e)),this.chatWindow_}),t});
